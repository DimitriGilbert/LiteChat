#!/bin/bash

# LiteChat Build & Release Script
# Usage: bin/builder [--release <name>] [--no-publish]

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
LANGUAGES=()
DEFAULT_LANG=""
BUILD_DIR="build"
RELEASE_DIR="release"
DIST_DIR="dist"

# Parse command line arguments
RELEASE_NAME=""
NO_PUBLISH=false

while [[ $# -gt 0 ]]; do
  case $1 in
    --release)
      RELEASE_NAME="$2"
      shift 2
      ;;
    --no-publish)
      NO_PUBLISH=true
      shift
      ;;
    -h|--help)
      echo "Usage: $0 [--release <name>] [--no-publish]"
      echo ""
      echo "Options:"
      echo "  --release <name>  Create a release with the specified name"
      echo "  --no-publish      Create release files but don't publish to GitHub"
      echo "  -h, --help        Show this help message"
      echo ""
      echo "Examples:"
      echo "  $0                                    # Build only"
      echo "  $0 --release v1.0.0                  # Build and create GitHub release"
      echo "  $0 --release cloneathon --no-publish # Build and create release files without publishing"
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      echo "Use --help for usage information"
      exit 1
      ;;
  esac
done

# Functions
log_info() {
  echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
  echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
  echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
  echo -e "${RED}[ERROR]${NC} $1"
}

detect_languages() {
  log_info "Detecting available languages..."
  if [ ! -d "src/locales" ]; then
    log_warning "'src/locales' directory not found. Skipping multi-language build features."
    return
  fi

  # Get subdirectories in src/locales
  LANGUAGES=($(find src/locales -mindepth 1 -maxdepth 1 -type d -exec basename {} \;))
  
  if [ ${#LANGUAGES[@]} -eq 0 ]; then
    log_warning "No language subdirectories found in 'src/locales'."
    LANGUAGES=()
    return
  fi

  log_info "Detected languages: ${LANGUAGES[*]}"

  # Determine default language (prefer 'en', otherwise first one)
  if [[ " ${LANGUAGES[*]} " =~ " en " ]]; then
    DEFAULT_LANG="en"
  else
    DEFAULT_LANG="${LANGUAGES[0]}"
  fi
  log_info "Default language set to: $DEFAULT_LANG"
}

cleanup_dirs() {
  log_info "Cleaning up previous builds..."
  rm -rf "$BUILD_DIR"
  if [[ -n "$RELEASE_NAME" ]]; then
    rm -rf "$RELEASE_DIR"
  fi
  
  if [ ${#LANGUAGES[@]} -gt 0 ]; then
    for lang in "${LANGUAGES[@]}"; do
      mkdir -p "$BUILD_DIR/$lang"
    done
  fi
}

create_directories() {
  log_info "Creating build directories..."
  mkdir -p "$BUILD_DIR"
  
  if [[ -n "$RELEASE_NAME" ]]; then
    mkdir -p "$RELEASE_DIR"
  fi
  
  if [ ${#LANGUAGES[@]} -gt 0 ]; then
    for lang in "${LANGUAGES[@]}"; do
      mkdir -p "$BUILD_DIR/$lang"
    done
  fi
}

build_project() {
  if [ ${#LANGUAGES[@]} -eq 0 ]; then
    # Single build mode
    log_info "Performing single, language-agnostic build..."
    rm -rf "$DIST_DIR"
    npm run build # Build without language env var
    if [[ ! -d "$DIST_DIR" ]]; then
      log_error "Build failed - dist directory not found"
      exit 1
    fi
    log_info "Copying build to $BUILD_DIR/"
    cp -r "$DIST_DIR"/* "$BUILD_DIR/"
    if [[ -n "$RELEASE_NAME" ]]; then
      log_info "Creating release zip: $RELEASE_DIR/$RELEASE_NAME.zip"
      (cd "$DIST_DIR" && zip -r "../$RELEASE_DIR/$RELEASE_NAME.zip" .)
    fi
    log_success "Single build completed."
  else
    # Multi-language build mode
    log_info "Performing multi-language builds for: ${LANGUAGES[*]}"
    
    # Build default language (en) first and put it at the root
    log_info "Building default language: $DEFAULT_LANG (will be placed at build root)"
    rm -rf "$DIST_DIR"
    export VITE_APP_LANG="$DEFAULT_LANG" && export VITE_BASE="/" && npm run build
    if [[ ! -d "$DIST_DIR" ]]; then
      log_error "Build failed for default language $DEFAULT_LANG - dist directory not found"
      exit 1
    fi
    
    # Copy default language to build root
    log_info "Copying default language build ($DEFAULT_LANG) to $BUILD_DIR/ root"
    cp -r "$DIST_DIR"/* "$BUILD_DIR/"
    
    # Create default release zip
    if [[ -n "$RELEASE_NAME" ]]; then
      log_info "Creating default release zip: $RELEASE_DIR/$RELEASE_NAME.zip"
      (cd "$DIST_DIR" && zip -r "../$RELEASE_DIR/$RELEASE_NAME.zip" .)
    fi
    log_success "Default language $DEFAULT_LANG build completed"
    
    # Build other languages and put them in subdirectories
    for lang in "${LANGUAGES[@]}"; do
      if [[ "$lang" == "$DEFAULT_LANG" ]]; then
        continue # Skip default language as it's already built
      fi
      
             log_info "Building language: $lang (will be placed in $BUILD_DIR/$lang/)"
       rm -rf "$DIST_DIR"
       export VITE_APP_LANG="$lang" && export VITE_BASE="/$lang/" && npm run build
      if [[ ! -d "$DIST_DIR" ]]; then
        log_error "Build failed for language $lang - dist directory not found"
        exit 1
      fi

      # Copy to language-specific directory
      log_info "Copying $lang build to $BUILD_DIR/$lang/"
      cp -r "$DIST_DIR"/* "$BUILD_DIR/$lang/"

      # Create language-specific release zip
      if [[ -n "$RELEASE_NAME" ]]; then
        log_info "Creating language-specific release zip: $RELEASE_DIR/$RELEASE_NAME.$lang.zip"
        (cd "$DIST_DIR" && zip -r "../$RELEASE_DIR/$RELEASE_NAME.$lang.zip" .)
      fi
      log_success "Language $lang build completed"
    done
  fi
}

create_github_release() {
  if [[ -z "$RELEASE_NAME" ]]; then
    return
  fi
  
  if [[ "$NO_PUBLISH" == true ]]; then
    log_warning "Release files created but not published to GitHub (--no-publish flag used)"
    log_info "Release files available in: $RELEASE_DIR/"
    ls -la "$RELEASE_DIR/"
    return
  fi
  
  log_info "Creating GitHub release: $RELEASE_NAME"
  
  # Check if gh CLI is available
  if ! command -v gh &> /dev/null; then
    log_error "GitHub CLI (gh) is not installed. Please install it to create releases."
    log_info "Release files are available in: $RELEASE_DIR/"
    exit 1
  fi
  
  # Check if we're in a git repository
  if ! git rev-parse --git-dir > /dev/null 2>&1; then
    log_error "Not in a git repository"
    exit 1
  fi
  
  # Get current branch for release notes
  CURRENT_BRANCH=$(git branch --show-current)
  
  # Prepare release assets
  RELEASE_ASSETS=()
  for file in "$RELEASE_DIR"/*.zip; do
    if [[ -f "$file" ]]; then
      RELEASE_ASSETS+=("$file")
    fi
  done
  
  if [[ ${#RELEASE_ASSETS[@]} -eq 0 ]]; then
    log_error "No release assets found in $RELEASE_DIR/"
    exit 1
  fi
  
  # Create the release
  log_info "Creating release with assets: ${RELEASE_ASSETS[*]}"
  
  # Generate release notes based on whether languages were built
  NOTES="Release $RELEASE_NAME built from branch $CURRENT_BRANCH on $(date)"
  if [ ${#LANGUAGES[@]} -gt 0 ]; then
      NOTES+="\n\nAvailable builds:\n- $RELEASE_NAME.zip: Default language ($DEFAULT_LANG)"
      for lang in "${LANGUAGES[@]}"; do
          NOTES+="\n- $RELEASE_NAME.$lang.zip: $lang version"
      done
  else
      NOTES+="\n\nSingle build asset:\n- $RELEASE_NAME.zip"
  fi

  gh release create "$RELEASE_NAME" \
    "${RELEASE_ASSETS[@]}" \
    --title "$RELEASE_NAME" \
    --notes-file <(echo -e "$NOTES") \
    --generate-notes
  
  log_success "GitHub release created successfully!"
  log_info "View the release at: $(gh browse --no-browser -p)/releases/tag/$RELEASE_NAME"
}

show_summary() {
  echo ""
  log_success "Build completed successfully!"
  echo ""
  echo "ðŸ“ Build Structure:"
  echo "â”œâ”€â”€ $BUILD_DIR/"
  if [ ${#LANGUAGES[@]} -gt 0 ]; then
    echo "â”‚   â”œâ”€â”€ (root: default language $DEFAULT_LANG)"
    for lang in "${LANGUAGES[@]}"; do
      if [[ "$lang" != "$DEFAULT_LANG" ]]; then
        echo "â”‚   â””â”€â”€ $lang/ (language-specific)"
      fi
    done
  else
    echo "â”‚   â””â”€â”€ (single language-agnostic build)"
  fi
  
  if [[ -n "$RELEASE_NAME" ]]; then
    echo "â”‚"
    echo "â”œâ”€â”€ $RELEASE_DIR/"
    echo "â”‚   â”œâ”€â”€ $RELEASE_NAME.zip"
    if [ ${#LANGUAGES[@]} -gt 0 ]; then
      for lang in "${LANGUAGES[@]}"; do
        echo "â”‚   â””â”€â”€ $RELEASE_NAME.$lang.zip"
      done
    fi
  fi
  echo ""
  
  # Show disk usage
  echo "ðŸ’¾ Build sizes:"
  du -sh "$BUILD_DIR"/* 2>/dev/null || true
  
  if [[ -n "$RELEASE_NAME" ]]; then
    echo ""
    echo "ðŸ“¦ Release sizes:"
    du -sh "$RELEASE_DIR"/* 2>/dev/null || true
  fi
}

# Main execution
main() {
  echo "ðŸš€ LiteChat Build & Release Script"
  echo "=================================="
  
  if [[ -n "$RELEASE_NAME" ]]; then
    log_info "Building for release: $RELEASE_NAME"
    if [[ "$NO_PUBLISH" == true ]]; then
      log_info "Release will be created locally only (--no-publish)"
    fi
  else
    log_info "Building without release"
  fi
  
  echo ""
  
  # Ensure we're in the right directory
  if [[ ! -f "package.json" ]]; then
    log_error "package.json not found. Please run this script from the project root."
    exit 1
  fi
  
  # Ensure zip is available
  if ! command -v zip &> /dev/null; then
    log_error "zip command is not available. Please install zip."
    exit 1
  fi
  
  detect_languages
  cleanup_dirs
  create_directories
  build_project
  create_github_release
  show_summary
  
  log_success "All done! ðŸŽ‰"
}

# Run main function
main "$@" 